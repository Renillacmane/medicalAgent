name: Deploy - Frontend

on:
  # Automatic triggers (disabled)
  # push:
  #   branches: [ main ]
  #   tags:
  #     - 'v*'
  
  # Manual trigger only
  workflow_dispatch:

env:
  PROD_FE_HOOK: ${{ secrets.PROD_FE_HOOK || 'http://localhost:3000/deploy' }}
  FE_URL: ${{ secrets.FE_URL || 'https://yourdomain.com' }}

jobs:
  deploy-traditional:
    name: Deploy to Production (Traditional)
    runs-on: ubuntu-latest
    environment:
      name: production
    
    steps:
      - name: Deploy to production
        id: deploy
        run: |
          echo "ðŸš€ Triggering production deployment hook..."
          
          PROD_FE_HOOK="${{ env.PROD_FE_HOOK }}"
          if [ "$PROD_FE_HOOK" = "http://localhost:3000/deploy" ]; then
            echo "âš ï¸ PROD_FE_HOOK not set, using default (deployment will fail)"
          fi
          echo "ðŸ“ Using hook URL: $PROD_FE_HOOK"
          
          response=$(curl -s -w "\n%{http_code}" -X POST "$PROD_FE_HOOK" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: workflow_dispatch" \
            -d "{\"ref\":\"${{ github.ref }}\",\"sha\":\"${{ github.sha }}\",\"actor\":\"${{ github.actor }}\"}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "âœ… Deployment hook triggered successfully (HTTP $http_code)"
            echo "Response: $body"
          else
            echo "âŒ Deployment hook failed with HTTP $http_code"
            echo "Response: $body"
            exit 1
          fi
        continue-on-error: false
      
      - name: Health check
        id: health-check
        run: |
          echo "ðŸ¥ Performing health check..."
          echo "â³ Waiting 90 seconds for deployment to complete..."
          sleep 90
          
          FE_URL="${{ env.FE_URL }}"
          if [ -z "$FE_URL" ] || [ "$FE_URL" = "https://yourdomain.com" ]; then
            echo "âš ï¸ FE_URL not set, skipping health check"
            exit 0
          fi
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "$FE_URL" > /dev/null; then
              echo "âœ… Health check passed"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Health check failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
            sleep 10
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1
        continue-on-error: false
      
      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment | ${{ steps.deploy.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ steps.health-check.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Frontend URL: ${{ env.FE_URL || 'Not configured' }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¡ Frontend Endpoint: \`${{ env.FE_URL || 'Not configured' }}\`" >> $GITHUB_STEP_SUMMARY
